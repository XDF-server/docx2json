#!/usr/local/python2.7/bin/python
#encoding=UTF-8

import MySQLdb
import gl
import re
import os
import json
import sys
from docxml import Docxml
from subprocess import call

host="10.60.0.151"
user="root"
passw="1a2s3dqwe"
dbase="test"
db = MySQLdb.connect(host,user,passw,dbase,charset="utf8" )

cursor = db.cursor()
#sql = '''SELECT o.id,question_docx,question_type,s.fullname,o.grade_id
#         FROM entity_question_old as o
#         LEFT JOIN entity_subject as s
#         on o.subject_id=s.id
#         where o.id='996599' and question_type='%(s)s' and question_docx is not null and state='1' ''' % dict(s=gl.q_type)

#files=open(sys.argv[1],'r')
#idlist=files.readline().strip()
#files.close()
sql = '''SELECT o.id,question_docx,question_type,s.fullname,o.grade_id
         FROM entity_question_old as o
         Left join entity_question_new_f as n
         on o.id=n.oldid
         LEFT JOIN entity_subject as s
         on o.subject_id=s.id
         where question_type='%(s)s' 
           and o.parent_question_id = 0 and n.detail is null
and n.oldid in 
(1245270,1245276,1245282,1245395,1245399,1245410,1245415,1245419,1245583,1245590,1245594,1245657,1245664,1245669,1245674,1245678,1245803,1245808,1245812,1245817,1245821,1245897,1245907,1246497,1246503,1246661,1246896,1246957,1246960,1247172,1247177,1247182,1247193,1247198,1247209,1247218,1247225,1247238,1247243,1247247,1247285,1247290,1247308,1247312,1247316,1247319,1247326,1247329,1247341,1247345,1247349,1247361,1247364,1247368,1247994,1247998,1248005,1248010,1248103,1248110,1248122,1248176,1248181,1248185,1248220,1248223,1248226,1248232,1248237,1248246,1248295,1248301,1248308,1248313,1248362,1248366,1248371,1248378,1248929,1248932,1249179,1249190,1249426,1249430,1249435,1249440,1251434,1251739,1251742,1251747,1253822,1253828,1253833,1253895,1253899,1253908,1254510,1254519,1254637,1254642,1254647,1254653,1254714,1254718,1254723,1254729,1254756,1254768,1254775,1254943,1254950,1254958,1254963,1255368,1255373,1255378,1255383,1255413,1255417,1255422,1255427,1255433,1255439,1255445,1255450,1255588,1255592,1255597,1255602,1255695,1255789,1255796,1255799,1255803,1255810,1256233,1256238,1256243,1256248,1256571,1256758,1256764,1256793,1256800,1256838,1256844,1256848,1256860,1256889,1256895,1257320,1257324,1257329,1257334,1257790,1257796,1257801,1257806,1258187,1258190,1258195,1258641,1258644,1258814,1258823,1258832,1258840,1259164,1259168,1259172,1259176,1259711,1259718,1259723,1259729,1259839,1259844,1259849,1259854,1259860,1259865,1260998,1261237,1261241,1261245,1261250,1261255,1261818,1261876,1261890,1261897,1262129,1262244,1262250,1262256,1262286,1262290,1262294,1262300,1262364,1262369,1262375,1262510,1262515,1262520,1262524,1262528,1262567,1262571,1262575,1262578,1262581,1262585,1262589,1262593,1262599,1262603,1262640,1262647,1262652,1262657,1262688,1262692,1262696,1262702,1262707,1262712,1262838,1262842,1262846,1262850,1262856,1262902,1262907,1262911,1262923,1263190,1263193,1263197,1263203,1263528,1263533,1263540,1263545,1263857,1263861,1263897,1263961,1263967,1263973,1263985,1264274,1264279,1264284,1264289,1264295,1264374,1264378,1264382,1264386,1264842,1264856,1264887,1264893,1264898,1264902,1264906,1264980,1264991,1264998,1265039,1265044,1265049,1265081,1265086,1265091,1265097,1265147,1265151,1265155,1265161,1265166,1265210,1265213,1265217,1265221,1265225,1265229,1265441,1265446,1265452,1265458,1265463,1265569,1265575,1265580,1265585,1265592,1265622,1265628,1265637,1265643,1265648,1265651,1265670,1265674,1265678,1265683,1265750,1265754,1265759,1265763,1265779,1265785,1265790,1265798,1265860,1265866,1265872,1265919,1265925,1265930,1265936,1265988,1265991,1265997,1266034,1266043,1266091,1266540,1266546,1266553,1266559,1266694,1266699,1266704,1266707,1266712,1266760,1266765,1266769,1267962,1267966,1268005,1268008,1268014,1268019,1268053,1268057,1268062,1268069,1268133,1268138,1268143,1268148,1268154,1268219,1268227,1268233,1268237,1268268,1268273,1268281,1268286,1268399,1268418,1268424,1268465,1268470,1268475,1268484,1268489,1268496,1268610,1268614,1268620,1268625,1269204,1269211,1269215,1269220,1269224,1269229,1269461,1269466,1269617,1269622,1269626,1269630,1269675,1269679,1269683,1269688,1269691,1269695,1269698,1269735,1269753,1269803,1269813,1269818,1269823,1269827,1269926,1269929,1269933,1269938,1269946,1270011,1270016,1270021,1270108,1270115,1270120,1270150,1270155,1270162,1270167,1270190,1270202,1270207,1270217,1270247,1270252,1270257,1270266,1270270,1270278,1270357,1270371,1270775,1270779,1270783,1270789,1271250,1271255,1271265,1271380,1271385,1271395,1271553,1271561,1271566,1271571,1272157,1272588,1273052,1273232,1273792,1273799,1273805,1273973,1273981,1273985,1273991,1274041,1274050,1274056,1274061,1274068,1274151,1274157,1274161,1274166,1274260,1274267,1274271,1274275,1274282,1274287,1274293,1274297,1274370,1274375,1274381,1274386,1274481,1274486,1274490,1274494,1274499,1274503,1274557,1274565,1274570,1274578,1274752,1274759,1274765,1275102,1275107,1275113,1275118,1275122,1275542,1275548,1275557,1275562,1275569,1275577,1275781,1275785,1275790,1275793,1278386,1278391,1278397,1278404,1278495,1278501,1278507,1278511,1278516,1278697,1278706,1278775,1278794,1278798,1278842,1278849,1278903,1278913,1278920,1278998,1279003,1279011,1279052,1279061,1279065,1279068,1279114,1279118,1279123,1279127,1279180,1279183,1279188,1279193,1279200,1279265,1279269,1280133,1280390,1280395,1283022,1283025,1283031,1283190,1283435,1283446,1283567,1283581,1283587,1283592,1283790,1283804,1283815,1284289,1284294,1286725,1286736,1286746,1289563,1289572,1289691,1290840,1290850,1291216,1291902,1291907,1291912,1292052,1292221,1292225,1292231,1292236,1292241,1292295,1292301,1292319,1292325,1292331,1292334,1292339,1292344,1292397,1292402,1292406,1292409,1292418,1292423,1292460,1292471,1292585,1292591,1292605,1292643,1292648,1292653,1292657,1292672,1292690,1292735,1292741,1292747,1292753,1292795,1292799,1292809,1292813,1292858,1292864,1292871,1292928,1292931,1292938,1292984,1292988,1292993,1292997,1293482,1293987,1294044,1294423,1295047,1295856,1295861,1295942,1298589,1298593,1298597,1298601,1301309,1301318,1301323,1301548,1301554,1301560,1301566,1301571,1302176,1302181,1302187,1302420,1302423,1302427,1304665,1306860,1306865,1306871,1306875,1306879,1307096,1307100,1307180,1307183,1307189,1307194,1307199,1307242,1307253,1307257,1307267,1307271,1307276,1307282,1307316,1307323,1307327,1307333,1307628,1307633,1307638,1307644,1307651,1307656,1307660,1307663,1307671,1307920,1307925,1307928,1307931,1307935,1307940,1307944,1307951,1307954,1308287,1308290,1308310,1308314,1308334,1308338,1308344,1308391,1308420,1308424,1308440,1308443,1308447,1308466,1308474,1308528,1308533,1308539,1308544,1308548,1308567,1308572,1308592,1308598,1308604,1308805,1309131,1309135,1309140,1309145,1309149,1309152,1309156,1309618,1309624,1309634,1309641,1310288,1310292,1310452,1310457,1310460,1310464,1310469,1310474,1310486,1310846,1310850,1310853,1310857,1310865,1311287,1311969,1311975,1311980,1311991,1311997,1312003,1312008,1312062,1312068,1312072,1312077,1312098,1312107,1312119,1312124,1312166,1312178,1312182,1312188,1312245,1312252,1312258,1312261,1312293,1312301,1312307,1312314,1312323,1312369,1312375,1312380,1312387,1312392,1312499,1312503,1312508,1312512,1312516,1312551,1312555,1312561,1312567,1312599,1312612,1312774,1312777,1312782,1312786,1312791,1312796,1312800,1312806,1312841,1312847,1312852,1312857,1312903,1312909,1312915,1312919,1312970,1312982,1313197,1313202,1313206,1313210,1313214,1313223,1313228,1313232,1313323,1313329,1313334,1313339,1313342,1313346,1313385,1313391,1313397,1313580,1313595,1313601,1313606,1313612,1313618,1313765,1313770,1313774,1313780,1313785,1313817,1313822,1314451,1314456,1314670,1314675,1314990,1314996,1315001,1315013,1315023,1315089,1315093,1315097,1315103,1315300,1315305,1315309,1315321,1315324,1315404,1315409,1315413,1315418,1315426,1315544,1315549,1315552,1315561,1315567,1315571,1315594,1315600,1315605,1315609,1315614,1315905,1316004,1316009,1316015,1316019,1316032,1316037,1316071,1316551,1316555,1316645,1316651,1316655,1316660,1316665,1316799,1317470,1318199,1318204,1318209,1318503,1318508,1318512,1318517,1318778,1318787,1318801,1318805,1318809,1318812,1318913,1318917,1319125,1319577,1319587,1319591,1319596,1319600,1319805,1319810,1319814,1319822,1319859,1319863,1319869,1319965,1319968,1319973,1319978,1321392,1321395,1321455,1321458,1321463,1321468,1321530,1321536,1321546,1322125,1322129,1322133,1322138,1322142,1322146,1322277,1322282,1322290,1322296,1322342,1322347,1322355,1322361,1322393,1322400,1322403,1322408,1322411,1324001,1324005,1324025,1324030,1324035,1324153,1324157,1325715,1326224,1328364,1328371,1328403,1328436,1328441,1328444,1328449,1328479,1328483,1328488,1328493,1328498,1328560,1328564,1328570,1328633,1328672,1328678,1328768,1328771,1328805,1328811,1328816,1328822,1328828,1328864,1328893,1328898,1328903,1328909,1337004,1337009,1337014,1337023,1337128,1337133,1337137,1337143,1337182,1338193,1338199,1338236,1338244,1338247,1338251,1338287,1338292,1338301,1338307,1338347,1338351,1338355,1338360,1338364,1338439,1338443,1338447,1338451,1345780,1345789,1345793,1345939,1345944,1345949,1345952,1346011,1346015,1346022,1346028,1346032,1346037,1346041,1346047,1346106,1346109,1346113,1346117,1346121,1346199,1346202,1346209,1346270,1346273,1346277,1346281,1346285,1346352,1346356,1346361,1346370,1346401,1346404,1346409,1346413,1346440,1346444,1346449,1346455,1346460,1346466,1346473,1346478,1346481,1346512,1346517,1346521,1346529,1346533,1346564,1346569,1346579,1346584,1346615,1346627,1346635,1346693,1346698,1346702,1346707,1346710,1346717,1346777,1346783,1346788,1346793,1346874,1348572,1348577,1348583,1348589,1348595,1348624,1348628,1348632,1348638,1348642,1355198,1355949,1357082,1357084,1357093,1357096,1357134,1357136,1357142,1357661,1357663,1357691,1357693,1357721,1357723,1357731,1357841,1357843,1357850,1357852,1357877,1357880,1357883,1358230,1358234,1358620,1358649,1358812,1358821,1358866,1360494,1360503,1360507,1360582,1360587,1360689,1360826,1361023,1361042,1361069,1362767,1363041,1363052,1363064,1363071,1363085,1363097,1363122,1364131,1364144,1364154,1364159,1364194,1364222,1364233,1364238,1364310,1364421,1364597,1364604,1364610,1364635,1364665,1364679,1364689,1364696,1366133,1366138,1366144,1366403,1366408,1366415,1366422,1378884,1379435,1379447)
           and question_docx is not null and state='ENABLED' ''' % dict(s=gl.main_q_type)
#           and n.oldid is null
#           and question_docx is not null and state='ENABLED' ''' % dict(s=gl.q_type,i=idlist)
#           and o.id in (%(i)s) 
#           and n.oldid is null and question_docx is not null and is_single=1 and subject_id in (1,2,19,5,6,21) and state='ENABLED' ''' % dict(s=gl.q_type)
#           and o.id = 21326
#           and o.id = 17701
#           and o.id = 24463 最后一种题型
#print sql

if gl.main_q_type == "现代文阅读":
	gl.main_q_type="现代文阅读题"

cursor.execute(sql)
results = cursor.fetchall()
for row in results:
	###全局变量初始化 start
	gl.question={'topic_type':{},'body':[],'options':[],'answer':[],'analysis':[]}
	gl.content={'material':[],'translation':[],'questions':[]}
	gl.sub_status = 0
	gl.type_status = ""
	gl.main_type_status = ""
	gl.type_change = ""
	gl.option_stat = ""
	gl.blank_num = 0
	gl.blank_cnt = 0
	gl.q_type=""
	###异常flg初始化
	gl.excep=0
	###全局变量初始化 end
	num = row[0]
	gl.oldid = num
	print "num: " + str(num)
	docfile = row[1]
	#qtype = row[2]
	qtype = gl.main_q_type
	suject = row[3]
	grade = row[4]
	if grade:
		#print "grade OK"
		grade=grade
	else:	
		grade = 0 
	#cmd = "wget -t 10 -T 20 -P /home/work/wzj/docx/ http://qd.okjiaoyu.cn/" + docfile
	docfile2 = ".ori.".join(docfile.split('.'))
	file_o = "/home/work/wzj/docx/" + docfile
	#retn=call(cmd,shell=True)
	if os.path.isfile(file_o) is False:
		#cmd = "wget -P /home/work/wzj/docx/ http://qd.okjiaoyu.cn/" + docfile2
		file_o = "/home/work/wzj/docx/" + docfile2
		#retn=call(cmd,shell=True)
		if os.path.isfile(file_o) is False:
			continue
	#print cmd

	print file_o
	docx = Docxml(file_o, '','')
	if gl.excep!=0:
		sql = '''insert into entity_question_new_f(oldid,detail) 
                    values('%(n)d','%(t)s')
                    on duplicate key update detail= '%(t)s' ''' % dict(n=num, t=str(gl.excep))
		cursor.execute(sql)
		db.commit()
		continue
	docx.parse()
	if gl.excep!=0:
		sql = '''insert into entity_question_new_f(oldid,detail) 
                    values('%(n)d','%(t)s')
                    on duplicate key update detail= '%(t)s' ''' % dict(n=num, t=str(gl.excep))
		cursor.execute(sql)
		db.commit()
		continue

	docx.subject(gl.main_q_type)
	if gl.excep!=0:
		sql = '''insert into entity_question_new_f(oldid,detail) 
                    values('%(n)d','%(t)s')
                    on duplicate key update detail= '%(t)s' ''' % dict(n=num, t=str(gl.excep))
		cursor.execute(sql)
		db.commit()
		continue

	if gl.question["topic_type"].has_key("id") and gl.question["topic_type"]["id"]:
		#if gl.question["topic_type"]["id"] == 2 and gl.question['answer'] and not gl.question['answer'][0].has_key('index'):
		if gl.question["topic_type"]["id"] == 2 :
			index=0
			tmp_ans=[]
			tmp_ans_group=[]
			for elem in gl.question['answer']:
				if elem['type']=="text":
					count=0
					for arr in re.split('#####',elem['value']): 
						if count:
							index+=1
							tmp_ans.append({'index':index,'group':tmp_ans_group})
							tmp_ans_group=[]
							count=0
						if arr:
							tmp_ans_group.append({"style": elem['style'], "align": elem['style'], "value": arr, "font": "", "type": "text", "size": ""})
						count=1
				elif elem['type']=="newline":
					if tmp_ans_group:
						index+=1
						tmp_ans.append({'index':index,'group':tmp_ans_group})
						tmp_ans_group=[]
				else:
					tmp_ans_group.append(elem)
			gl.question['answer']=tmp_ans
			if gl.blank_cnt!=index:
				gl.excep=22
				print "###gl.excep22: " + str(gl.excep)
				sql = '''insert into entity_question_new_f(oldid,detail)
                    values('%(n)d','%(t)s')
                    on duplicate key update detail= '%(t)s' ''' % dict(n=num, t=str(gl.excep))
				cursor.execute(sql)
				db.commit()
				continue
				print "###blank "+ str(gl.b_num)
				print "###answer "+ str(index)+": " + json.dumps(gl.question['answer'], ensure_ascii=0)
		gl.content["questions"].append(gl.question)

	try:
		js=json.dumps(gl.content, ensure_ascii=0)
		js=db.escape_string(js)
		sql = '''insert into entity_question_new_f(oldid,type,json,subject,grade_id) 
                         values('%(n)d','%(t)s','%(j)s','%(s)s','%(g)d')
                         on duplicate key update type= '%(t)s' , json='%(j)s' , subject='%(s)s' , 
                         grade_id='%(g)d' , detail = null ''' % dict(n=num, t=qtype, j=js, s=suject, g=grade)
		#try:
		#print sql
		cursor.execute(sql)
		db.commit()
		#except:
		#	db.rollback()
		#	print "insert NG"
	except:
		gl.excep=9
		sql = '''insert into entity_question_new_f(oldid,detail) 
                    values('%(n)d','%(t)s')
                    on duplicate key update detail= '%(t)s' ''' % dict(n=num, t=str(gl.excep))
		cursor.execute(sql)
		db.commit()


db.close()

#docx = Docxml('/home/wzj/docx/test3.docx', '/home/wzj/docx2json/template','tag')
#docx = Docxml('/home/wzj/docx/AFD234asdfasdf.docx', '','')
#docx = Docxml('/home/work/wzj/docx/test4.docx', '','')

#print json.dumps(gl.question, ensure_ascii=0)
